<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI in Health Ed: Categorizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
        <!-- QR Code library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Custom styles for aesthetic appeal */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }

        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }

        .category-item {
            border-left: 4px solid #4f46e5;
        }

        .animate-pulse-new {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                background-color: #f0f9ff;
            }

            50% {
                background-color: #e0f2fe;
            }
        }
    </style>
</head>

<body class="p-4 md:p-8 min-h-screen bg-gray-100 flex items-start justify-center">

    <div class="w-full max-w-4xl">
        <div class="flex justify-end gap-2 mb-4">
            <a id="vizLink" href="/visualize" class="inline-block bg-green-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out">Visualization</a>
            <a href="/login" class="inline-block bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out">Admin</a>
        </div>
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700">AI in Health Ed Categorizer</h1>
            <p class="text-xl text-gray-500 mt-2">Use the power of Gemini and Structured Output to classify interests.
            </p>
        </header>

        <!-- QR Code (floating bottom-right) -->
        <div class="fixed bottom-6 right-6 z-10">
            <div class="card bg-white p-4 rounded-xl border border-gray-200 shadow-lg">
                <p class="text-sm text-gray-600 mb-2 text-center">Scan to open this slide</p>
                <div id="qr-code" class="flex justify-center"></div>
            </div>
        </div>

        <!-- Main Input Card -->
        <div id="questions-container" class="space-y-8"></div>

        <!-- Categorized Results Card -->
        <div id="results-card" class="card bg-white p-6 rounded-xl" style="display:none">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Categorized Interests (<span
                        id="category-count">0</span>)</h2>
                <button onclick="fetchAndRenderCategories()"
                    class="text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.564c.594.614.939 1.4.939 2.223 0 1.258-.724 2.378-1.801 2.943l-.386.193a1.001 1.001 0 11-.963-1.748l.386-.193c.69-.35 1.144-1.037 1.144-1.874 0-.462-.162-.897-.47-1.226l-.497-.52A5.002 5.002 0 005 8V6.101a1 1 0 012 0V8a3 3 0 003 3h3a1 1 0 110 2H10a5 5 0 11-5-5V3a1 1 0 011-1z"
                            clip-rule="evenodd" />
                    </svg>
                    Refresh
                </button>
            </div>

            <div id="categories-list" class="space-y-4">
                <p id="loading-initial" class="text-center text-gray-500">Loading existing categories...</p>
            </div>
        </div>

        <p class="text-xs text-center text-gray-400 mt-6">
            Backend API: http://localhost:8000
        </p>
    </div>

    <script>
        // NOTE: Ensure your FastAPI server (main.py) is running on port 8000 for this to work.
        const API_BASE_URL = '';
        const urlParams = new URLSearchParams(window.location.search);
        const presentation = urlParams.get('p') || 'default';
        const pageUrl = `${window.location.origin}/?p=${encodeURIComponent(presentation)}`;

        const questionsContainer = document.getElementById('questions-container');
        const categoriesList = document.getElementById('categories-list');
        const categoryCount = document.getElementById('category-count');

        /**
         * Converts a raw category string (e.g., 'Simulation_Training') into a display name
         * (e.g., 'Simulation Training').
         * @param {string} key 
         * @returns {string}
         */
        function formatCategoryName(key) {
            return key.replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        /**
         * Displays a temporary message to the user.
         * @param {string} message 
         * @param {string} type 'success' or 'error'
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Fetches all categories from the backend and renders them.
         */
        async function fetchAndRenderCategories(question = 'General') {
            categoriesList.innerHTML = '<p class="text-center text-gray-500">Refreshing categories...</p>';
            categoryCount.textContent = '...';
            try {
                const response = await fetch(`${API_BASE_URL}/categories?p=${encodeURIComponent(presentation)}&question=${encodeURIComponent(question)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                renderCategories(data);

            } catch (error) {
                console.error('Error fetching categories:', error);
                categoriesList.innerHTML = '<p class="text-center text-red-500">Could not connect to backend API.</p>';
                categoryCount.textContent = '0';
            }
        }

        async function fetchAndRenderQuestions() {
            try {
                const response = await fetch(`${API_BASE_URL}/questions?p=${encodeURIComponent(presentation)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const questions = await response.json();
                renderQuestionsBlocks(questions);

            } catch (error) {
                console.error('Error fetching questions:', error);
                questionsContainer.innerHTML = '<p class="text-center text-red-500">Could not load questions.</p>';
            }
        }

        function renderQuestionsBlocks(questions) {
            questionsContainer.innerHTML = '';
            if (!Array.isArray(questions) || questions.length === 0) {
                questionsContainer.innerHTML = '<p class="text-center text-gray-500">No questions available. Please ask the admin to add one.</p>';
                return;
            }

            questions.forEach((q, idx) => {
                const card = document.createElement('div');
                card.className = 'card bg-white p-6 rounded-xl';

                const title = document.createElement('h2');
                title.className = 'text-2xl font-semibold text-gray-800 mb-2';
                title.textContent = `Question ${idx + 1}:`;

                const qText = document.createElement('p');
                qText.className = 'text-lg mb-4 italic text-gray-600';
                qText.textContent = q;

                const textarea = document.createElement('textarea');
                textarea.className = 'w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-28 resize-none';
                textarea.placeholder = 'Type your answer here...';
                textarea.maxLength = 500;

                const submit = document.createElement('button');
                submit.className = 'mt-4 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50';
                submit.textContent = 'Categorize Answer';
                submit.onclick = async () => submitAnswerForQuestion(q, textarea, submit);

                const msg = document.createElement('div');
                msg.className = 'mt-4 p-3 rounded-lg hidden text-sm font-medium';

                // Per-question categories section
                const results = document.createElement('div');
                results.className = 'card bg-white p-4 rounded-xl mt-6 border border-gray-200';
                const resultsHeader = document.createElement('div');
                resultsHeader.className = 'flex justify-between items-center mb-4';
                const resultsTitle = document.createElement('h3');
                resultsTitle.className = 'text-xl font-semibold text-gray-800';
                resultsTitle.textContent = 'Categorized Interests';
                const counterLabel = document.createElement('span');
                counterLabel.innerHTML = '(<span class="font-mono" id="cnt">0</span>)';
                resultsHeader.appendChild(resultsTitle);
                resultsHeader.appendChild(counterLabel);
                const categoriesForQ = document.createElement('div');
                categoriesForQ.className = 'space-y-4';
                results.appendChild(resultsHeader);
                results.appendChild(categoriesForQ);

                // No charts on home page

                card.appendChild(title);
                card.appendChild(qText);
                card.appendChild(textarea);
                card.appendChild(submit);
                card.appendChild(msg);
                card.appendChild(results);

                questionsContainer.appendChild(card);

                // Initial load for this question
                fetchAndRenderCategoriesFor(q, categoriesForQ, counterLabel.querySelector('#cnt'));
            });
        }

        function renderCategories(categories, highlightCategory = null) {
            const categoryKeys = Object.keys(categories).sort();
            categoriesList.innerHTML = '';
            categoryCount.textContent = categoryKeys.length;

            if (categoryKeys.length === 0) {
                categoriesList.innerHTML = '<p class="text-center text-gray-500">No interests categorized yet. Be the first!</p>';
                return;
            }

            categoryKeys.forEach(categoryName => {
                const answers = categories[categoryName];
                const isHighlighted = highlightCategory === categoryName;

                const categoryElement = document.createElement('div');
                categoryElement.className = `category-item p-4 rounded-lg bg-white border border-gray-200 ${isHighlighted ? 'animate-pulse-new border-indigo-500' : ''}`;

                const title = document.createElement('h3');
                title.className = `text-xl font-bold ${isHighlighted ? 'text-indigo-600' : 'text-gray-700'} mb-2`;
                title.innerHTML = `${categoryName} <span class="text-base text-gray-400 font-normal ml-2">(${answers.length} response${answers.length !== 1 ? 's' : ''})</span>`;

                const answerList = document.createElement('ul');
                answerList.className = 'list-disc ml-6 space-y-2 text-gray-600 text-sm mt-3';

                answers.forEach(answer => {
                    const listItem = document.createElement('li');
                    listItem.textContent = answer;
                    answerList.appendChild(listItem);
                });

                categoryElement.appendChild(title);
                categoryElement.appendChild(answerList);
                categoriesList.appendChild(categoryElement);

                // Stop highlighting after a short period
                if (isHighlighted) {
                    setTimeout(() => {
                        categoryElement.classList.remove('animate-pulse-new', 'border-indigo-500');
                    }, 5000);
                }
            });
        }

        async function fetchAndRenderCategoriesFor(question, listContainerEl, countEl) {
            listContainerEl.innerHTML = '<p class="text-center text-gray-500">Refreshing categories...</p>';
            if (countEl) countEl.textContent = '...';
            try {
                const response = await fetch(`${API_BASE_URL}/categories?p=${encodeURIComponent(presentation)}&question=${encodeURIComponent(question)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                renderCategoriesInto(listContainerEl, countEl, data);
            } catch (error) {
                console.error('Error fetching categories:', error);
                listContainerEl.innerHTML = '<p class="text-center text-red-500">Could not connect to backend API.</p>';
                if (countEl) countEl.textContent = '0';
            }
        }

        function renderCategoriesInto(targetListEl, targetCountEl, categories, highlightCategory = null) {
            const categoryKeys = Object.keys(categories).sort();
            targetListEl.innerHTML = '';
            if (targetCountEl) targetCountEl.textContent = categoryKeys.length;

            if (categoryKeys.length === 0) {
                targetListEl.innerHTML = '<p class="text-center text-gray-500">No interests categorized yet. Be the first!</p>';
                return;
            }

            categoryKeys.forEach(categoryName => {
                const answers = categories[categoryName];
                const isHighlighted = highlightCategory === categoryName;

                const categoryElement = document.createElement('div');
                categoryElement.className = `category-item p-4 rounded-lg bg-white border border-gray-200 ${isHighlighted ? 'animate-pulse-new border-indigo-500' : ''}`;

                const title = document.createElement('h3');
                title.className = `text-xl font-bold ${isHighlighted ? 'text-indigo-600' : 'text-gray-700'} mb-2`;
                title.innerHTML = `${categoryName} <span class="text-base text-gray-400 font-normal ml-2">(${answers.length} response${answers.length !== 1 ? 's' : ''})</span>`;

                const answerList = document.createElement('ul');
                answerList.className = 'list-disc ml-6 space-y-2 text-gray-600 text-sm mt-3';

                answers.forEach(answer => {
                    const listItem = document.createElement('li');
                    listItem.textContent = answer;
                    answerList.appendChild(listItem);
                });

                categoryElement.appendChild(title);
                categoryElement.appendChild(answerList);
                targetListEl.appendChild(categoryElement);

                if (isHighlighted) {
                    setTimeout(() => {
                        categoryElement.classList.remove('animate-pulse-new', 'border-indigo-500');
                    }, 5000);
                }
            });
        }

        // Charts removed from home page

        /**
         * Handles the form submission and categorization process.
         */
        async function submitAnswerForQuestion(question, textarea, buttonEl) {
            const answerText = textarea.value.trim();
            if (!answerText) {
                showMessageFor(buttonEl, "Please enter your answer before submitting.", 'error');
                return;
            }

            buttonEl.disabled = true;
            const oldText = buttonEl.textContent;
            buttonEl.textContent = 'Analyzing with Gemini...';

            try {
                const response = await fetch(`${API_BASE_URL}/categorize?p=${encodeURIComponent(presentation)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer: answerText, question })
                });

                const result = await response.json();

                if (!response.ok) {
                    showMessageFor(buttonEl, `Error: ${result.detail || 'Failed to categorize answer.'}`, 'error');
                    return;
                }

                textarea.value = '';

                let msg = result.message;
                msg += result.is_new ? ' (A new category was created!)' : ' (Placed into an existing category.)';
                showMessageFor(buttonEl, msg, 'success');

                // Refresh categories for this question
                const card = buttonEl.parentElement;
                const listEl = card.querySelector('.space-y-4');
                const cntEl = card.querySelector('#cnt');
                fetchAndRenderCategoriesFor(question, listEl, cntEl);

            } catch (error) {
                console.error('Submission Error:', error);
                showMessageFor(buttonEl, 'A network error occurred. Is the FastAPI server running?', 'error');
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = oldText;
            }
        }

        function showMessageFor(buttonEl, message, type) {
            // Find sibling message box in the same card
            const card = buttonEl.parentElement;
            const msgEl = card.querySelector('.mt-4.p-3');
            msgEl.textContent = message;
            msgEl.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'success') {
                msgEl.classList.add('bg-green-100', 'text-green-700');
            } else {
                msgEl.classList.add('bg-red-100', 'text-red-700');
            }
            setTimeout(() => msgEl.classList.add('hidden'), 5000);
        }

        // Initialize on page load
        window.onload = function() {
            fetchAndRenderQuestions();

            // Render QR code for audience
            const qrContainer = document.getElementById('qr-code');
            if (qrContainer && window.QRCode) {
                new QRCode(qrContainer, {
                    text: pageUrl,
                    width: 128,
                    height: 128,
                });
            }

            // Wire visualization link with current presentation
            const vizLink = document.getElementById('vizLink');
            if (vizLink) {
                vizLink.href = `/visualize?p=${encodeURIComponent(presentation)}`;
            }
        };

    </script>
</body>

</html>
